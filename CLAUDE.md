# CLAUDE.md - AI 编码指南

本文档为 AI 助手提供项目的编码标准和设计指南。

## 代码质量标准

### TypeScript 指南
- 所有函数必须有明确的返回类型注解
- 避免使用 `any` 类型，使用 `unknown` 代替
- 优先使用 `interface` 定义数据结构
- 使用严格的 TypeScript 配置

### 函数风格
- 优先使用 `function` 关键字声明顶层函数
- 使用 `async function` 而非 `const fn = async () => {}`
- 箭头函数仅用于回调和简短的内联函数
- 导出的函数必须添加 JSDoc 注释

### 错误处理
- 使用统一的错误处理工具（`handleCommandError`）
- 在命令处理函数中使用 `try-catch`
- 记录详细的错误日志，包含上下文信息
- 向用户返回友好的错误消息

### 导入规范
- 按类型分组导入：外部库 → 内部模块 → 类型定义
- 使用相对路径导入项目内部模块
- 避免循环依赖

## 设计方向

### 数据存储原则
- **最小化存储**：仅存储无法实时获取的核心数据
- **实时获取**：用户名、头像、角色名等通过 Discord API 实时查询
- **按需加载**：避免启动时批量加载大量数据

### 架构设计
- **模块化**：命令、工具、模型、处理器分离
- **单一职责**：每个模块只负责一个功能领域
- **统一接口**：错误处理、日志记录、数据验证使用统一工具

### 性能策略
- **智能缓存**：限制缓存大小，定期自动清理
- **批量操作**：数据库写入使用批量操作
- **字段过滤**：查询时只获取必需字段

## 编码规范

### 命名约定
- **变量/函数**：camelCase（如 `getUserData`）
- **类/接口**：PascalCase（如 `IVRChatBinding`）
- **常量**：UPPER_SNAKE_CASE（如 `MAX_LIMIT`）
- **文件名**：camelCase（如 `commandHandler.ts`）

### 文件组织
```
src/
├── commands/        # 命令处理函数
│   ├── admin/      # 管理员命令
│   └── server/     # 服务器命令
├── models/         # 数据模型（Mongoose schemas）
├── handlers/       # 事件处理器
├── utils/          # 工具函数
├── config/         # 配置文件
└── types/          # TypeScript 类型定义
```

### 注释规范
- **函数注释**：使用 JSDoc 格式，说明功能、参数、返回值
- **复杂逻辑**：添加行内注释解释原因
- **避免**：不要为显而易见的代码添加注释

### 代码风格
- 使用 2 空格缩进
- 单引号用于字符串（除非包含单引号）
- 使用模板字符串拼接变量
- 避免嵌套三元运算符，使用 `if-else` 或 `switch`

## 开发指南

### 添加新命令
1. 在 `src/commands/` 下创建命令处理函数
2. 在 `src/register_commands.ts` 中注册命令定义
3. 在 `src/handlers/commandHandler.ts` 中添加路由
4. 使用统一的错误处理和权限检查

### 数据库操作
- 使用 Mongoose 模型操作数据
- 查询时使用 `.lean()` 返回纯 JS 对象以提升性能
- 敏感操作添加事务支持
- 建立合适的索引优化查询

### 日志记录
- 使用统一的 `logger` 工具
- 根据严重程度选择级别：`debug`、`info`、`warn`、`error`
- 记录关键操作和错误时包含上下文信息
- 避免记录敏感信息（如 Token）

### 环境变量
- 所有配置通过环境变量控制
- 在 `.env.example` 中记录所有可用变量
- 启动时验证必需的环境变量
- 提供合理的默认值

### 测试原则
- 修改代码后检查 linter 错误
- 测试命令的权限检查
- 验证错误处理是否正确
- 确保数据库操作的原子性

## Discord.js 最佳实践

### 缓存管理
- 限制缓存大小（如成员缓存限制为 200）
- 配置自动清理策略（sweepers）
- 按需获取数据，避免 `fetchAll()`

### 交互响应
- 3 秒内响应（使用 `deferReply` 处理长操作）
- 使用 `MessageFlags.Ephemeral` 发送私密消息
- 正确处理 `deferred` 和 `replied` 状态

### 权限检查
- 使用统一的权限检查函数（`requireAdmin`、`requireOwner`）
- 在命令处理函数开头进行权限验证
- 返回清晰的权限错误消息

## 安全规范

### 输入验证
- 所有用户输入必须验证
- 使用专门的验证函数（如 `validateVRChatName`）
- 限制输入长度和格式

### 数据保护
- 不在日志中记录敏感信息
- 使用环境变量存储密钥
- API 访问实施速率限制

### 错误信息
- 向用户返回友好的错误消息
- 不暴露内部实现细节
- 记录完整的错误堆栈到日志

## 代码审查检查清单

- [ ] 代码符合 TypeScript 规范
- [ ] 函数有返回类型注解
- [ ] 错误处理完整
- [ ] 日志记录适当
- [ ] 输入验证到位
- [ ] 权限检查正确
- [ ] 无 linter 错误
- [ ] 注释清晰有用
- [ ] 变量命名语义化
- [ ] 无硬编码配置

## 工作流程

### 代码编辑后的检查流程

每次编辑完代码文件后，必须执行以下步骤：

1. **运行 `/code-simplifier`** - 自动优化代码结构
   - 简化复杂逻辑
   - 统一代码风格
   - 提升可读性
   - 确保符合项目规范

2. **检查 linter 错误** - 确保代码质量
   - 修复所有 TypeScript 错误
   - 修复所有 ESLint 警告

3. **验证功能完整性** - 确保改动不破坏功能
   - 代码逻辑保持一致
   - 所有原有功能正常工作

### 代码简化原则

使用 `/code-simplifier` 时遵循以下原则：

- ✅ 优先可读性而非简洁性
- ✅ 避免嵌套三元运算符，使用 `if-else` 或 `switch`
- ✅ 使用 `function` 关键字而非箭头函数（顶层函数）
- ✅ 保持显式的类型注解
- ✅ 消除不必要的注释
- ✅ 合并相关逻辑
- ❌ 不要为了减少行数而牺牲清晰度
- ❌ 不要创建过于巧妙难懂的解决方案
- ❌ 不要改变代码的功能和行为

## 持续改进

- 保持代码简洁和可读性
- 避免过度设计
- 优先功能完整性，再考虑性能优化
- 记录重要的设计决策
- 保持文档与代码同步
- 每次代码修改后执行 `/code-simplifier` 检查