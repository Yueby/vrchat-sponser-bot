# VRChat Sponsor Bot

åŸºäº Discord.js å’Œ MongoDB çš„å¤šæœåŠ¡å™¨èµåŠ©è€…ç®¡ç†ç³»ç»Ÿï¼Œä¸“ä¸º VRChat ä¸–ç•Œè®¾è®¡ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### å¤šæœåŠ¡å™¨æ”¯æŒ
- ğŸ¢ **å®Œå…¨éš”ç¦»**ï¼šæ¯ä¸ª Discord æœåŠ¡å™¨ç‹¬ç«‹æ•°æ®
- ğŸš€ **è‡ªåŠ¨åŒæ­¥**ï¼šBot å¯åŠ¨å’ŒåŠ å…¥æœåŠ¡å™¨æ—¶è‡ªåŠ¨åŒæ­¥æˆå‘˜
- ğŸ”„ **å®æ—¶æ›´æ–°**ï¼šæˆå‘˜åŠ å…¥/ç¦»å¼€è‡ªåŠ¨æ›´æ–°æ•°æ®åº“
- ğŸ“Š **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æ•°æ®åº“æ“ä½œï¼Œ1000 æˆå‘˜åŒæ­¥ä»…éœ€ 1 ç§’

### æ•°æ®ç®¡ç†
- ğŸ’¾ **æœ€å°åŒ–å­˜å‚¨**ï¼šä»…å­˜å‚¨æ ¸å¿ƒæ•°æ®ï¼ˆroles ID, isBooster ç­‰ï¼‰
- ğŸ” **å®æ—¶è·å–**ï¼šæ‰€æœ‰å±•ç¤ºæ•°æ®ï¼ˆç”¨æˆ·åã€å¤´åƒã€è§’è‰²åï¼‰åŠ¨æ€æŸ¥è¯¢
- âœ… **è¾“å…¥éªŒè¯**ï¼šVRChat åç§°æ ¼å¼å’Œé•¿åº¦éªŒè¯
- ğŸ”’ **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´ TypeScript ç±»å‹å®šä¹‰

### API åŠŸèƒ½
- ğŸŒ **RESTful API**ï¼šæŒ‰æœåŠ¡å™¨è·å–èµåŠ©è€…åˆ—è¡¨
- ğŸ­ **è§’è‰²åˆ†ç»„**ï¼šè‡ªåŠ¨æŒ‰ Discord è§’è‰²åˆ†ç»„è¿”å›
- ğŸ” **è®¿é—®æ§åˆ¶**ï¼šæœåŠ¡å™¨æ‰€æœ‰è€…å¯å¯ç”¨/ç¦ç”¨ API
- âš¡ **é™æµä¿æŠ¤**ï¼š180 æ¬¡/åˆ†é’Ÿ

### å¤–éƒ¨ç”¨æˆ·æ”¯æŒ
- ğŸ‘¥ **ä¸­å›½ç”¨æˆ·å‹å¥½**ï¼šæ”¯æŒæ— æ³•åŠ å…¥ Discord æœåŠ¡å™¨çš„ç”¨æˆ·
- ğŸ­ **è™šæ‹Ÿè§’è‰²**ï¼šä½¿ç”¨æœåŠ¡å™¨ç°æœ‰è§’è‰²åç§°
- ğŸ“ **ç®¡ç†å‘˜ç®¡ç†**ï¼šç”±ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ å’Œç»´æŠ¤
- ğŸ”— **å¯é€‰å…³è”**ï¼šå¯å…³è” Discord è´¦å·ï¼ˆå¦‚æœ‰ï¼‰

---

## ğŸ® å‘½ä»¤åˆ—è¡¨

### ç”¨æˆ·å‘½ä»¤
- `/changename <name>` - ç»‘å®šæˆ–æ›´æ–° VRChat åå­—
- `/whoami` - æŸ¥çœ‹è‡ªå·±çš„ç»‘å®šçŠ¶æ€å’Œä¿¡æ¯

### æœåŠ¡å™¨ç®¡ç†å‘½ä»¤ï¼ˆç®¡ç†å‘˜/æ‰€æœ‰è€…ï¼‰
- `/server stats` - æŸ¥çœ‹æœåŠ¡å™¨ç»Ÿè®¡ä¿¡æ¯å’Œ API çŠ¶æ€
- `/server api <enabled>` - å¯ç”¨/ç¦ç”¨ API è®¿é—®ï¼ˆä»…æ‰€æœ‰è€…ï¼‰

### ç®¡ç†å‘˜å‘½ä»¤
- `/admin sync` - æ‰‹åŠ¨åŒæ­¥æ‰€æœ‰æˆå‘˜æ•°æ®
- `/admin unbind <user>` - å¼ºåˆ¶è§£ç»‘æŒ‡å®šç”¨æˆ·

### å¤–éƒ¨ç”¨æˆ·ç®¡ç†å‘½ä»¤ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
- `/external add` - æ·»åŠ æ— æ³•åŠ å…¥æœåŠ¡å™¨çš„å¤–éƒ¨ç”¨æˆ·
- `/external update` - æ›´æ–°å¤–éƒ¨ç”¨æˆ·ä¿¡æ¯
- `/external remove` - åˆ é™¤å¤–éƒ¨ç”¨æˆ·
- `/external list` - åˆ—å‡ºæ‰€æœ‰å¤–éƒ¨ç”¨æˆ·

---

## ğŸŒ API ç«¯ç‚¹

### `GET /api/vrchat/sponsors/:guildId`

è¿”å›æŒ‡å®šæœåŠ¡å™¨çš„èµåŠ©è€…åˆ—è¡¨ï¼ˆVRChat DataDictionary æ ¼å¼ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "VIP": {
    "0": {
      "vrchatName": "VRChatUser1",
      "displayName": "DiscordNick1",
      "avatar": "https://cdn.discordapp.com/avatars/...",
      "isBooster": true,
      "joinedAt": "2024-01-01T00:00:00.000Z",
      "supportDays": 365
    }
  },
  "Member": {
    "0": { ... }
  },
  "allRoles": ["VIP", "Member"]
}
```

**ç‰¹ç‚¹**ï¼š
- ä»…è¿”å›æœ‰è§’è‰²çš„ç”¨æˆ·
- æŒ‰è§’è‰²åˆ†ç»„
- ç”¨æˆ·å¯ä»¥å‡ºç°åœ¨å¤šä¸ªè§’è‰²ç»„ä¸­
- è‡ªåŠ¨è®¡ç®—æ”¯æŒå¤©æ•°
- åŒ…å«æœåŠ¡å™¨æˆå‘˜å’Œå¤–éƒ¨ç”¨æˆ·
- `isExternal` å­—æ®µåŒºåˆ†ç”¨æˆ·ç±»å‹

**é”™è¯¯å“åº”**ï¼š
- `404` - æœåŠ¡å™¨æœªæ‰¾åˆ°
- `403` - API è®¿é—®å·²ç¦ç”¨
- `500` - å†…éƒ¨é”™è¯¯

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒè¦æ±‚
- Node.js 18+ 
- MongoDB Atlas è´¦æˆ·ï¼ˆæˆ–æœ¬åœ° MongoDBï¼‰
- Discord Bot Token

### 2. å®‰è£…ä¾èµ–
```bash
# ä½¿ç”¨ pnpmï¼ˆæ¨èï¼‰
pnpm install

# æˆ–ä½¿ç”¨ npm
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡
å¤åˆ¶ `.env.example` ä¸º `.env` å¹¶å¡«å†™ï¼š
```env
DISCORD_TOKEN=your_bot_token
CLIENT_ID=your_application_id
MONGO_URI=mongodb+srv://user:pass@cluster.mongodb.net/dbname
PORT=3000
```

### 4. ç¼–è¯‘ TypeScript
```bash
pnpm run build
```

### 5. æ³¨å†Œå‘½ä»¤
```bash
pnpm run register
```

### 6. å¯åŠ¨ Bot
```bash
# ç”Ÿäº§ç¯å¢ƒ
pnpm start

# å¼€å‘ç¯å¢ƒï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
pnpm run dev
```

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ bot.ts                    # Bot ä¸»å…¥å£
â”œâ”€â”€ server.ts                 # Express API æœåŠ¡å™¨
â”œâ”€â”€ index.ts                  # åº”ç”¨å¯åŠ¨å…¥å£
â”œâ”€â”€ commands/                 # å‘½ä»¤å¤„ç†å™¨
â”‚   â”œâ”€â”€ changename.ts        # /changename å‘½ä»¤
â”‚   â”œâ”€â”€ whoami.ts            # /whoami å‘½ä»¤
â”‚   â”œâ”€â”€ server/              # /server å‘½ä»¤ç»„
â”‚   â”‚   â”œâ”€â”€ stats.ts
â”‚   â”‚   â””â”€â”€ api.ts
â”‚   â””â”€â”€ admin/               # /admin å‘½ä»¤ç»„
â”‚       â”œâ”€â”€ sync.ts
â”‚       â””â”€â”€ unbind.ts
â”œâ”€â”€ handlers/                 # äº‹ä»¶å¤„ç†å™¨
â”‚   â”œâ”€â”€ commandHandler.ts    # å‘½ä»¤è·¯ç”±
â”‚   â”œâ”€â”€ guildEvents.ts       # æœåŠ¡å™¨äº‹ä»¶
â”‚   â””â”€â”€ memberEvents.ts      # æˆå‘˜äº‹ä»¶
â”œâ”€â”€ models/                   # MongoDB æ¨¡å‹
â”‚   â”œâ”€â”€ Guild.ts             # æœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ DiscordUser.ts       # ç”¨æˆ·æ•°æ®
â”‚   â”œâ”€â”€ VRChatBinding.ts     # VRChat ç»‘å®š
â”‚   â””â”€â”€ ExternalUser.ts      # å¤–éƒ¨ç”¨æˆ·
â”œâ”€â”€ utils/                    # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ logger.ts            # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ errors.ts            # é”™è¯¯å¤„ç†
â”‚   â”œâ”€â”€ discord.ts           # Discord å·¥å…·
â”‚   â”œâ”€â”€ validation.ts        # è¾“å…¥éªŒè¯
â”‚   â”œâ”€â”€ database.ts          # æ‰¹é‡æ“ä½œ
â”‚   â””â”€â”€ external.ts          # å¤–éƒ¨ç”¨æˆ·å·¥å…·
â”œâ”€â”€ types/                    # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ api.ts               # API ç±»å‹
â””â”€â”€ config/                   # é…ç½®
    â””â”€â”€ constants.ts         # å¸¸é‡é…ç½®
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| åŒæ­¥ 1000 æˆå‘˜ | ~1 ç§’ |
| API å“åº”æ—¶é—´ | <100ms |
| æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– | æ‰¹é‡æ“ä½œ |
| å†…å­˜ç®¡ç† | è‡ªåŠ¨æ¸…ç†å†·å´è®°å½• |
| é€Ÿç‡é™åˆ¶ | 180 æ¬¡/åˆ†é’Ÿ |

---

## ğŸ”§ ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡ | å¿…éœ€ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `DISCORD_TOKEN` | âœ… | Discord Bot Token | - |
| `CLIENT_ID` | âœ… | Discord Application ID | - |
| `MONGO_URI` | âœ… | MongoDB è¿æ¥å­—ç¬¦ä¸² | - |
| `PORT` | âŒ | HTTP æœåŠ¡å™¨ç«¯å£ | 3000 |
| `SERVER_PORT` | âŒ | å¤‡ç”¨ç«¯å£ï¼ˆPterodactylï¼‰ | - |
| `LOG_LEVEL` | âŒ | æ—¥å¿—çº§åˆ« | INFO |

---

## ğŸ“ å¼€å‘è¯´æ˜

### æ—¥å¿—çº§åˆ«
è®¾ç½® `LOG_LEVEL` ç¯å¢ƒå˜é‡ï¼š
- `DEBUG` - è°ƒè¯•ä¿¡æ¯
- `INFO` - ä¸€èˆ¬ä¿¡æ¯ï¼ˆé»˜è®¤ï¼‰
- `WARN` - è­¦å‘Šä¿¡æ¯
- `ERROR` - ä»…é”™è¯¯

### ä»£ç è´¨é‡
- âœ… å®Œæ•´ TypeScript ç±»å‹
- âœ… ESLint è§„åˆ™
- âœ… ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
- âœ… è¾“å…¥éªŒè¯
- âœ… é”™è¯¯å¤„ç†

### æ•°æ®åº“ç´¢å¼•
è‡ªåŠ¨åˆ›å»ºçš„ç´¢å¼•ï¼š
- `Guild`: `guildId` (unique)
- `DiscordUser`: `(userId, guildId)` (unique composite)
- `VRChatBinding`: `(discordUserId, guildId)` (unique composite)
- `ExternalUser`: `(vrchatName, guildId)` (unique composite)
- `ExternalUser`: `(discordUserId, guildId)` (unique sparse)

---

## ğŸ¯ è®¾è®¡ç†å¿µ

### æœ€å°åŒ–å­˜å‚¨
ä»…å­˜å‚¨æ— æ³•å®æ—¶è·å–çš„æ ¸å¿ƒæ•°æ®ï¼š
- âœ… å­˜å‚¨ï¼šroles ID, isBooster, joinedAt
- âŒ ä¸å­˜å‚¨ï¼šusername, avatar, displayName, roleNames

### å®æ—¶æ•°æ®
æ‰€æœ‰å±•ç¤ºæ•°æ®é€šè¿‡ Discord API å®æ—¶è·å–ï¼š
- ç”¨æˆ·åã€å¤´åƒï¼š`client.users.cache.get()`
- è§’è‰²åï¼š`guild.roles.cache.get()`
- æ˜¾ç¤ºåï¼š`guild.members.cache.get()`

### æ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡æ•°æ®åº“æ“ä½œï¼ˆ`bulkWrite`ï¼‰
- å†·å´è®°å½•è‡ªåŠ¨æ¸…ç†
- æ•°æ®åº“æŸ¥è¯¢å­—æ®µè¿‡æ»¤
- API æ‰¹é‡è·å–æˆå‘˜

---

## ğŸ› å¸¸è§é—®é¢˜

**Q: Bot æ— æ³•åŒæ­¥æˆå‘˜ï¼Ÿ**  
A: ç¡®ä¿ Bot æ‹¥æœ‰ `GuildMembers` Intentï¼ˆåœ¨ Discord Developer Portal å¯ç”¨ï¼‰

**Q: API è¿”å› 403ï¼Ÿ**  
A: ä½¿ç”¨ `/server api true` å‘½ä»¤å¯ç”¨ API è®¿é—®

**Q: ç”¨æˆ·é‡æ–°åŠ å…¥æœåŠ¡å™¨åæ•°æ®ä¸¢å¤±ï¼Ÿ**  
A: æ•°æ®åœ¨ç”¨æˆ·ç¦»å¼€æ—¶è‡ªåŠ¨åˆ é™¤ï¼Œé‡æ–°åŠ å…¥éœ€è¦é‡æ–°ç»‘å®š

**Q: å¦‚ä½•æ·»åŠ æ— æ³•åŠ å…¥æœåŠ¡å™¨çš„ç”¨æˆ·ï¼Ÿ**  
A: ä½¿ç”¨ `/external add` å‘½ä»¤æ·»åŠ å¤–éƒ¨ç”¨æˆ·ï¼Œä»–ä»¬ä¼šå‡ºç°åœ¨ API è¿”å›ä¸­

**Q: å¤–éƒ¨ç”¨æˆ·å’ŒæœåŠ¡å™¨æˆå‘˜æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**  
A: å¤–éƒ¨ç”¨æˆ·ä½¿ç”¨è™šæ‹Ÿè§’è‰²ï¼Œä¸èƒ½æ˜¯ Boosterï¼ŒAPI è¿”å›ä¸­ `isExternal` ä¸º `true`

**Q: ç¼–è¯‘å¤±è´¥ï¼Ÿ**  
A: ç¡®ä¿ TypeScript ç‰ˆæœ¬ >= 5.0ï¼Œè¿è¡Œ `pnpm install` é‡æ–°å®‰è£…ä¾èµ–

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

## ğŸ“® è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ GitHub ä¸Šæäº¤ Issueã€‚
